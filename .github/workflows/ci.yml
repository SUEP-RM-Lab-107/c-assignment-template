name: C Assignment CI

on: [push, pull_request]

jobs:
  # ========== 阶段 1：基础编译与测试（所有平台） ==========
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # 即使一个平台失败，也继续测试其他平台
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
            cxx: g++
          - os: macos-latest
            cc: clang
            cxx: clang++
          - os: windows-latest
            cc: cl # Visual Studio 编译器
            cxx: cl

    steps:
      - uses: actions/checkout@v4

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.20"

      # Linux 特定：安装 valgrind 用于内存检查（可选）
      - name: Install Valgrind (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y valgrind

      # Windows 特定：设置 MSVC 环境
      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2

      # 配置阶段
      - name: Configure CMake
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows_NT" ]; then
            cmake -B build -S . -G "Visual Studio 17 2022" -A x64 \
              -DCMAKE_C_FLAGS="/W4 /WX" \
              -DCMAKE_BUILD_TYPE=Debug
          else
            cmake -B build -S . \
              -DCMAKE_C_COMPILER=${{ matrix.cc }} \
              -DCMAKE_CXX_COMPILER=${{ matrix.cc }} \
              -DCMAKE_C_FLAGS="-Wall -Wextra -Wpedantic -Werror" \
              -DCMAKE_BUILD_TYPE=Debug
          fi

      # 构建阶段
      - name: Build
        run: cmake --build build --config Debug --parallel

      # 测试阶段（使用 CTest）
      - name: Test
        working-directory: build
        run: ctest -C Debug --output-on-failure --verbose

      # 内存泄漏检测（仅 Linux，使用 Valgrind）
      - name: Memory Check (Valgrind)
        if: runner.os == 'Linux'
        working-directory: build
        run: |
          if [ -f "./test_runner" ]; then
            valgrind --leak-check=full --error-exitcode=1 ./test_runner
          elif [ -f "./CAssignment" ]; then
            valgrind --leak-check=full --error-exitcode=1 ./CAssignment
          fi

  # ========== 阶段 2：代码风格检查（仅 Linux） ==========
  lint:
    name: Code Style Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      # 检查 src/ 和 include/ 目录下的 C 文件格式
      # 需要项目根目录有 .clang-format 文件（Google/WebKit/Mozilla 风格）
      - name: Check Formatting
        run: |
          find src include \( -name "*.c" -o -name "*.h" \) | xargs clang-format --dry-run --Werror

      # 如果没有 .clang-format，生成一个 Google 风格的
      - name: Generate clang-format if missing
        if: failure()
        run: |
          if [ ! -f .clang-format ]; then
            echo "提示：检测到代码风格问题。在项目根目录运行："
            echo "clang-format -i src/*.c include/*.h"
            echo "或添加 .clang-format 文件（Google/WebKit 风格）"
          fi

  # ========== 阶段 3：作业提交规范检查 ==========
  submission-check:
    name: Submission Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 检查 1：禁止提交 build/ 目录
      - name: Check for Build Artifacts
        run: |
          if [ -d "build" ]; then
            echo "::error::错误：提交中包含 build/ 目录！请删除后重新提交："
            echo "  git rm -rf build/"
            echo "  git commit -m 'Remove build directory'"
            exit 1
          fi

      # 检查 2：禁止提交二进制文件（.exe, .o, 无扩展名可执行文件）
      - name: Check for Binaries
        run: |
          # 查找常见的编译产物
          if find . \( -name "*.exe" -o -name "*.o" -o -name "*.obj" -o -name "*.a" -o -name "*.so" \) | grep -q .; then
            echo "::error::错误：提交中包含编译产物（.exe/.o 等）！请清理："
            echo "  git clean -fdx  # 谨慎使用，会删除所有未跟踪文件"
            echo "  或手动删除后提交"
            exit 1
          fi

          # 检查根目录下是否有意外生成的无扩展名可执行文件（Unix）
          if [ -f "./CAssignment" ] || [ -f "./test_runner" ]; then
            echo "::error::错误：提交中包含可执行文件！请删除："
            echo "  git rm CAssignment test_runner"
            exit 1
          fi

      # 检查 3：README 必须存在
      - name: Check Documentation
        run: |
          if [ ! -f "README.md" ]; then
            echo "::warning::警告：缺少 README.md 文件"
          fi

      # 检查 4：代码文件大小限制（防止提交意外的大文件）
      - name: Check File Sizes
        run: |
          max_size=1048576  # 1MB
          large_files=$(find src include tests -type f -size +${max_size}c 2>/dev/null || true)
          if [ ! -z "$large_files" ]; then
            echo "::error::错误：以下文件超过 1MB，可能包含不当内容："
            echo "$large_files"
            exit 1
          fi
